#!/usr/bin/env sh

set -e

echo $P12_CERT | base64 -D > cert/cert.p12 > /dev/null 2>&1
sudo security unlock-keychain -p circle circle.keychain
sudo security import cert/cert.p12 -k circle.keychain -T /usr/bin/codesign

gem install gym github-markup redcarpet --no-ri --no-rdoc
gym
ditto -c -k --sequesterRsrc --keepParent SpechtLite.app SpechtLite.zip

export GOPATH=$HOME/golang
export PATH=$PATH:$GOPATH/bin
github-release release \
  --user zhuhaow \
  --repo SpechtLite \
  --tag $CIRCLE_TAG \
  --name $CIRCLE_TAG \
  --description $CIRCLE_TAG

echo $DSA_PRIVATE_KEY | base64 -D > cert/dsa_priv.pem > /dev/null 2>&1

bin/publish_appcast
